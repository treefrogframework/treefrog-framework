
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><link rel="canonical" href="http://mongoc.org/libbson/current/using_client_side_encryption.html"/>
    <title>Using Client-Side Field Level Encryption &#8212; libmongoc 1.21.2</title>
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="Aids for Debugging" href="debugging.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="api.html" title="API Reference"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="debugging.html" title="Aids for Debugging"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">libmongoc 1.21.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="guides.html" accesskey="U">Guides</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-client-side-field-level-encryption">
<h1>Using Client-Side Field Level Encryption<a class="headerlink" href="#using-client-side-field-level-encryption" title="Permalink to this headline">¶</a></h1>
<p>New in MongoDB 4.2, Client-Side Field Level Encryption (also referred to as Client-Side Encryption) allows administrators and developers to encrypt specific data fields in addition to other MongoDB encryption features.</p>
<p>With Client-Side Encryption, developers can encrypt fields client side without any server-side configuration or directives. Client-Side Encryption supports workloads where applications must guarantee that unauthorized parties, including server administrators, cannot read the encrypted data.</p>
<p>Automatic encryption, where sensitive fields in commands are encrypted automatically, requires an Enterprise-only process to do query analysis.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="libmongocrypt">
<h3>libmongocrypt<a class="headerlink" href="#libmongocrypt" title="Permalink to this headline">¶</a></h3>
<p>There is a separate library, <a class="reference external" href="https://github.com/mongodb/libmongocrypt">libmongocrypt</a>, that must be installed prior to configuring libmongoc to enable Client-Side Encryption.</p>
<p>libmongocrypt depends on libbson. To build libmongoc with Client-Side Encryption support you must:</p>
<ol class="arabic simple">
<li><p>Install libbson</p></li>
<li><p>Build and install libmongocrypt</p></li>
<li><p>Build libmongoc</p></li>
</ol>
<p>To install libbson, follow the instructions to install with a package manager: <a class="reference internal" href="installing.html#installing-libbson-with-pkg-manager"><span class="std std-ref">Install libbson with a Package Manager</span></a> or build from source with cmake (disable building libmongoc with <code class="docutils literal notranslate"><span class="pre">-DENABLE_MONGOC=OFF</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd mongo-c-driver
$ mkdir cmake-build &amp;&amp; cd cmake-build
$ cmake -DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -DENABLE_MONGOC=OFF ..
$ cmake --build . --target install
</pre></div>
</div>
<p>To build and install libmongocrypt, clone <a class="reference external" href="https://github.com/mongodb/libmongocrypt">the repository</a> and configure as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd libmongocrypt
$ mkdir cmake-build &amp;&amp; cd cmake-build
$ cmake -DENABLE_SHARED_BSON=ON ..
$ cmake --build . --target install
</pre></div>
</div>
<p>Then, you should be able to build libmongoc with Client-Side Encryption.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd mongo-c-driver
$ mkdir cmake-build &amp;&amp; cd cmake-build
$ cmake -DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -DENABLE_MONGOC=ON -DENABLE_CLIENT_SIDE_ENCRYPTION=ON ..
$ cmake --build . --target install
</pre></div>
</div>
</div>
<div class="section" id="mongocryptd">
<h3>mongocryptd<a class="headerlink" href="#mongocryptd" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> binary is required for automatic Client-Side Encryption and is included as a component in the <a class="reference external" href="https://dochub.mongodb.org/core/install-mongodb-enterprise">MongoDB Enterprise Server package</a>. For detailed installation instructions see the <a class="reference external" href="https://dochub.mongodb.org/core/client-side-field-level-encryption-mongocryptd">MongoDB documentation on mongocryptd</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> performs the following:</p>
<ul class="simple">
<li><p>Parses the automatic encryption rules specified to the database connection. If the JSON schema contains invalid automatic encryption syntax or any document validation syntax, <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> returns an error.</p></li>
<li><p>Uses the specified automatic encryption rules to mark fields in read and write operations for encryption.</p></li>
<li><p>Rejects read/write operations that may return unexpected or incorrect results when applied to an encrypted field. For supported and unsupported operations, see <a class="reference external" href="https://dochub.mongodb.org/core/client-side-field-level-encryption-read-write-support">Read/Write Support with Automatic Field Level Encryption</a>.</p></li>
</ul>
<p>A <a class="symbol reference internal" href="mongoc_client_t.html"><span class="doc">mongoc_client_t</span></a> configured with auto encryption will automatically spawn the <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> process from the application’s <code class="docutils literal notranslate"><span class="pre">PATH</span></code>. Applications can control the spawning behavior as part of the automatic encryption options. For example, to set a custom path to the <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> process, set the <code class="docutils literal notranslate"><span class="pre">mongocryptdSpawnPath</span></code> with <a class="symbol reference internal" href="mongoc_auto_encryption_opts_set_extra.html"><span class="doc">mongoc_auto_encryption_opts_set_extra()</span></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">bson_t</span> <span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;mongocryptdSpawnPath&quot;</span><span class="p">,</span> <span class="s">&quot;/path/to/mongocryptd&quot;</span><span class="p">);</span>
<span class="n">mongoc_auto_encryption_opts_set_extra</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
</pre></div>
</div>
<p>To control the logging output of <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> pass <code class="docutils literal notranslate"><span class="pre">mongocryptdSpawnArgs</span></code> to <a class="symbol reference internal" href="mongoc_auto_encryption_opts_set_extra.html"><span class="doc">mongoc_auto_encryption_opts_set_extra()</span></a>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">bson_t</span> <span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;mongocryptdSpawnArgs&quot;</span><span class="p">,</span>
   <span class="s">&quot;[&quot;</span><span class="p">,</span> <span class="s">&quot;--logpath=/path/to/mongocryptd.log&quot;</span><span class="p">,</span> <span class="s">&quot;--logappend&quot;</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">mongoc_auto_encryption_opts_set_extra</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
</pre></div>
</div>
<p>If your application wishes to manage the <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> process manually, it is possible to disable spawning <code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">bson_t</span> <span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;mongocryptdBypassSpawn&quot;</span><span class="p">,</span>
   <span class="n">BCON_BOOL</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span> <span class="s">&quot;mongocryptdURI&quot;</span><span class="p">,</span> <span class="s">&quot;mongodb://localhost:27020&quot;</span><span class="p">);</span>
<span class="n">mongoc_auto_encryption_opts_set_extra</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> is only responsible for supporting automatic Client-Side Encryption in the driver and does not itself perform any encryption or decryption.</p>
</div>
</div>
<div class="section" id="automatic-client-side-field-level-encryption">
<h2>Automatic Client-Side Field Level Encryption<a class="headerlink" href="#automatic-client-side-field-level-encryption" title="Permalink to this headline">¶</a></h2>
<p>Automatic Client-Side Encryption is enabled by calling <a class="symbol reference internal" href="mongoc_client_enable_auto_encryption.html"><span class="doc">mongoc_client_enable_auto_encryption()</span></a> on a <a class="symbol reference internal" href="mongoc_client_t.html"><span class="doc">mongoc_client_t</span></a>. The following examples show how to set up automatic client-side field level encryption using <a class="symbol reference internal" href="mongoc_client_encryption_t.html"><span class="doc">mongoc_client_encryption_t</span></a> to create a new encryption data key.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Automatic client-side field level encryption requires MongoDB 4.2 enterprise or a MongoDB 4.2 Atlas cluster. The community version of the server supports automatic decryption as well as <a class="reference internal" href="#explicit-client-side-encryption"><span class="std std-ref">Explicit Encryption</span></a>.</p>
</div>
<div class="section" id="providing-local-automatic-encryption-rules">
<h3>Providing Local Automatic Encryption Rules<a class="headerlink" href="#providing-local-automatic-encryption-rules" title="Permalink to this headline">¶</a></h3>
<p>The following example shows how to specify automatic encryption rules using a schema map set with <a class="symbol reference internal" href="mongoc_auto_encryption_opts_set_schema_map.html"><span class="doc">mongoc_auto_encryption_opts_set_schema_map()</span></a>. The automatic encryption rules are expressed using a strict subset of the JSON Schema syntax.</p>
<p>Supplying a schema map provides more security than relying on JSON Schemas obtained from the server. It protects against a malicious server advertising a false JSON Schema, which could trick the client into sending unencrypted data that should be encrypted.</p>
<p>JSON Schemas supplied in the schema map only apply to configuring automatic client-side field level encryption. Other validation rules in the JSON schema will not be enforced by the driver and will result in an error:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-schema-map.c</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span><span class="cp"></span>

<span class="cm">/* Helper method to create a new data key in the key vault, a schema to use that</span>
<span class="cm"> * key, and writes the schema to a file for later use. */</span>
<span class="k">static</span> <span class="kt">bool</span>
<span class="nf">create_schema_file</span> <span class="p">(</span><span class="n">bson_t</span> <span class="o">*</span><span class="n">kms_providers</span><span class="p">,</span>
                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyvault_db</span><span class="p">,</span>
                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyvault_coll</span><span class="p">,</span>
                    <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">keyvault_client</span><span class="p">,</span>
                    <span class="n">bson_error_t</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_client_encryption_t</span> <span class="o">*</span><span class="n">client_encryption</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_opts_t</span> <span class="o">*</span><span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_datakey_opts_t</span> <span class="o">*</span><span class="n">datakey_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_value_t</span> <span class="n">datakey_id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;mongoc_encryption_example_1&quot;</span><span class="p">};</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">schema</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">schema_string</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">schema_string_len</span><span class="p">;</span>
   <span class="kt">FILE</span> <span class="o">*</span><span class="n">outfile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

   <span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                    <span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">client_encryption_opts</span><span class="p">,</span> <span class="n">keyvault_db</span><span class="p">,</span> <span class="n">keyvault_coll</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_client</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                      <span class="n">keyvault_client</span><span class="p">);</span>

   <span class="n">client_encryption</span> <span class="o">=</span>
      <span class="n">mongoc_client_encryption_new</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a new data key and json schema for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
   <span class="n">datakey_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_datakey_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span> <span class="p">(</span>
      <span class="n">datakey_opts</span><span class="p">,</span> <span class="n">keyaltnames</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_client_encryption_create_datakey</span> <span class="p">(</span>
          <span class="n">client_encryption</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="n">datakey_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a schema describing that &quot;encryptedField&quot; is a string encrypted</span>
<span class="cm">    * with the newly created data key using deterministic encryption. */</span>
   <span class="n">schema</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;properties&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;encryptedField&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;encrypt&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;keyId&quot;</span><span class="p">,</span>
                      <span class="s">&quot;[&quot;</span><span class="p">,</span>
                      <span class="n">BCON_BIN</span> <span class="p">(</span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">subtype</span><span class="p">,</span>
                                <span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data_len</span><span class="p">),</span>
                      <span class="s">&quot;]&quot;</span><span class="p">,</span>
                      <span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
                      <span class="s">&quot;string&quot;</span><span class="p">,</span>
                      <span class="s">&quot;algorithm&quot;</span><span class="p">,</span>
                      <span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">,</span>
                      <span class="s">&quot;}&quot;</span><span class="p">,</span>
                      <span class="s">&quot;}&quot;</span><span class="p">,</span>
                      <span class="s">&quot;}&quot;</span><span class="p">,</span>
                      <span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
                      <span class="s">&quot;object&quot;</span><span class="p">);</span>

   <span class="cm">/* Use canonical JSON so that other drivers and tools will be</span>
<span class="cm">    * able to parse the MongoDB extended JSON file. */</span>
   <span class="n">schema_string</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schema_string_len</span><span class="p">);</span>
   <span class="n">outfile</span> <span class="o">=</span> <span class="n">fopen</span> <span class="p">(</span><span class="s">&quot;jsonSchema.json&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">fwrite</span> <span class="p">(</span><span class="n">schema_string</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">schema_string_len</span><span class="p">,</span> <span class="n">outfile</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;failed to write to file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
   <span class="n">mongoc_client_encryption_destroy</span> <span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_datakey_opts_destroy</span> <span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_destroy</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">schema_string</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">schema</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fclose</span> <span class="p">(</span><span class="n">outfile</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This example demonstrates how to use automatic encryption with a client-side</span>
<span class="cm"> * schema map using the enterprise version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

   <span class="kt">int</span> <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">local_masterkey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">local_masterkey_len</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">kms_providers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">index_keys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">index_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_index_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_json_reader_t</span> <span class="o">*</span><span class="n">reader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">BSON_INITIALIZER</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">schema_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="cm">/* The MongoClient used to access the key vault (keyvault_namespace). */</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">keyvault_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">keyvault_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_auto_encryption_opts_t</span> <span class="o">*</span><span class="n">auto_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">to_insert</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">unencrypted_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">unencrypted_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create the encryption key. */</span>
   <span class="n">local_masterkey</span> <span class="o">=</span>
      <span class="n">hex_to_bin</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span> <span class="o">||</span> <span class="n">local_masterkey_len</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
               <span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">kms_providers</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
                             <span class="s">&quot;{&quot;</span><span class="p">,</span>
                             <span class="s">&quot;key&quot;</span><span class="p">,</span>
                             <span class="n">BCON_BIN</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">local_masterkey</span><span class="p">,</span> <span class="n">local_masterkey_len</span><span class="p">),</span>
                             <span class="s">&quot;}&quot;</span><span class="p">);</span>

   <span class="cm">/* Set up the key vault for this example. */</span>
   <span class="n">keyvault_client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span>
      <span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-keyvault&quot;</span><span class="p">);</span>
   <span class="n">keyvault_coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span>
      <span class="n">keyvault_client</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
   <span class="n">index_keys</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">index_name</span> <span class="o">=</span> <span class="n">mongoc_collection_keys_to_index_string</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">create_index_cmd</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;createIndexes&quot;</span><span class="p">,</span>
                                <span class="n">KEYVAULT_COLL</span><span class="p">,</span>
                                <span class="s">&quot;indexes&quot;</span><span class="p">,</span>
                                <span class="s">&quot;[&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;key&quot;</span><span class="p">,</span>
                                <span class="n">BCON_DOCUMENT</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">),</span>
                                <span class="s">&quot;name&quot;</span><span class="p">,</span>
                                <span class="n">index_name</span><span class="p">,</span>
                                <span class="s">&quot;unique&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;$exists&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;]&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_command_simple</span> <span class="p">(</span><span class="n">keyvault_client</span><span class="p">,</span>
                                       <span class="n">KEYVAULT_DB</span><span class="p">,</span>
                                       <span class="n">create_index_cmd</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* read prefs */</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span>
                                       <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a new data key and a schema using it for encryption. Save the</span>
<span class="cm">    * schema to the file jsonSchema.json */</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">create_schema_file</span> <span class="p">(</span>
      <span class="n">kms_providers</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">,</span> <span class="n">keyvault_client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Load the JSON Schema and construct the local schema_map option. */</span>
   <span class="n">reader</span> <span class="o">=</span> <span class="n">bson_json_reader_new_from_file</span> <span class="p">(</span><span class="s">&quot;jsonSchema.json&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reader</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">bson_json_reader_read</span> <span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schema</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="cm">/* Construct the schema map, mapping the namespace of the collection to the</span>
<span class="cm">    * schema describing encryption. */</span>
   <span class="n">schema_map</span> <span class="o">=</span>
      <span class="n">BCON_NEW</span> <span class="p">(</span><span class="n">ENCRYPTED_DB</span> <span class="s">&quot;.&quot;</span> <span class="n">ENCRYPTED_COLL</span><span class="p">,</span> <span class="n">BCON_DOCUMENT</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">schema</span><span class="p">));</span>

   <span class="n">auto_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_auto_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_auto_encryption_opts_set_keyvault_client</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                                    <span class="n">keyvault_client</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">auto_encryption_opts</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                                  <span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_set_schema_map</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                               <span class="n">schema_map</span><span class="p">);</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>

   <span class="cm">/* Enable automatic encryption. It will determine that encryption is</span>
<span class="cm">    * necessary from the schema map instead of relying on the server to provide</span>
<span class="cm">    * a schema. */</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_enable_auto_encryption</span> <span class="p">(</span>
      <span class="n">client</span><span class="p">,</span> <span class="n">auto_encryption_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

   <span class="cm">/* Clear old data */</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="n">to_insert</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span> <span class="s">&quot;123456789&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_collection_insert_one</span> <span class="p">(</span>
      <span class="n">coll</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* opts */</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;decrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="n">unencrypted_client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span>
      <span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-unencrypted&quot;</span><span class="p">);</span>
   <span class="n">unencrypted_coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span>
      <span class="n">unencrypted_client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_free</span> <span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">index_name</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_index_cmd</span><span class="p">);</span>
   <span class="n">bson_json_reader_destroy</span> <span class="p">(</span><span class="n">reader</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_destroy</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">keyvault_client</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">schema</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">schema_map</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>
   <span class="k">return</span> <span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="server-side-field-level-encryption-enforcement">
<h3>Server-Side Field Level Encryption Enforcement<a class="headerlink" href="#server-side-field-level-encryption-enforcement" title="Permalink to this headline">¶</a></h3>
<p>The MongoDB 4.2 server supports using schema validation to enforce encryption of specific fields in a collection. This schema validation will prevent an application from inserting unencrypted values for any fields marked with the “encrypt” JSON schema keyword.</p>
<p>The following example shows how to set up automatic client-side field level encryption using <a class="symbol reference internal" href="mongoc_client_encryption_t.html"><span class="doc">mongoc_client_encryption_t</span></a> to create a new encryption data key and create a collection with the Automatic Encryption JSON Schema Syntax:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-server-schema.c</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span><span class="cp"></span>

<span class="cm">/* Helper method to create and return a JSON schema to use for encryption.</span>
<span class="cm">The caller will use the returned schema for server-side encryption validation.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">bson_t</span> <span class="o">*</span>
<span class="nf">create_schema</span> <span class="p">(</span><span class="n">bson_t</span> <span class="o">*</span><span class="n">kms_providers</span><span class="p">,</span>
               <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyvault_db</span><span class="p">,</span>
               <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keyvault_coll</span><span class="p">,</span>
               <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">keyvault_client</span><span class="p">,</span>
               <span class="n">bson_error_t</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_client_encryption_t</span> <span class="o">*</span><span class="n">client_encryption</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_opts_t</span> <span class="o">*</span><span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_datakey_opts_t</span> <span class="o">*</span><span class="n">datakey_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_value_t</span> <span class="n">datakey_id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;mongoc_encryption_example_2&quot;</span><span class="p">};</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">schema</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                    <span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">client_encryption_opts</span><span class="p">,</span> <span class="n">keyvault_db</span><span class="p">,</span> <span class="n">keyvault_coll</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_client</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                      <span class="n">keyvault_client</span><span class="p">);</span>

   <span class="n">client_encryption</span> <span class="o">=</span>
      <span class="n">mongoc_client_encryption_new</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a new data key and json schema for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
   <span class="n">datakey_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_datakey_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span> <span class="p">(</span>
      <span class="n">datakey_opts</span><span class="p">,</span> <span class="n">keyaltnames</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_client_encryption_create_datakey</span> <span class="p">(</span>
          <span class="n">client_encryption</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="n">datakey_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a schema describing that &quot;encryptedField&quot; is a string encrypted</span>
<span class="cm">    * with the newly created data key using deterministic encryption. */</span>
   <span class="n">schema</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;properties&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;encryptedField&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;encrypt&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;keyId&quot;</span><span class="p">,</span>
                      <span class="s">&quot;[&quot;</span><span class="p">,</span>
                      <span class="n">BCON_BIN</span> <span class="p">(</span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">subtype</span><span class="p">,</span>
                                <span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data_len</span><span class="p">),</span>
                      <span class="s">&quot;]&quot;</span><span class="p">,</span>
                      <span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
                      <span class="s">&quot;string&quot;</span><span class="p">,</span>
                      <span class="s">&quot;algorithm&quot;</span><span class="p">,</span>
                      <span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">,</span>
                      <span class="s">&quot;}&quot;</span><span class="p">,</span>
                      <span class="s">&quot;}&quot;</span><span class="p">,</span>
                      <span class="s">&quot;}&quot;</span><span class="p">,</span>
                      <span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
                      <span class="s">&quot;object&quot;</span><span class="p">);</span>

<span class="nl">fail</span><span class="p">:</span>
   <span class="n">mongoc_client_encryption_destroy</span> <span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_datakey_opts_destroy</span> <span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_destroy</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">schema</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This example demonstrates how to use automatic encryption with a server-side</span>
<span class="cm"> * schema using the enterprise version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

   <span class="kt">int</span> <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">local_masterkey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">local_masterkey_len</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">kms_providers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">index_keys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">index_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_index_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_json_reader_t</span> <span class="o">*</span><span class="n">reader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">schema</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="cm">/* The MongoClient used to access the key vault (keyvault_namespace). */</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">keyvault_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">keyvault_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_auto_encryption_opts_t</span> <span class="o">*</span><span class="n">auto_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">to_insert</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">unencrypted_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">unencrypted_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_cmd_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_write_concern_t</span> <span class="o">*</span><span class="n">wc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create</span>
<span class="cm">    * the encryption key. */</span>
   <span class="n">local_masterkey</span> <span class="o">=</span>
      <span class="n">hex_to_bin</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span> <span class="o">||</span> <span class="n">local_masterkey_len</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
               <span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">kms_providers</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
                             <span class="s">&quot;{&quot;</span><span class="p">,</span>
                             <span class="s">&quot;key&quot;</span><span class="p">,</span>
                             <span class="n">BCON_BIN</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">local_masterkey</span><span class="p">,</span> <span class="n">local_masterkey_len</span><span class="p">),</span>
                             <span class="s">&quot;}&quot;</span><span class="p">);</span>

   <span class="cm">/* Set up the key vault for this example. */</span>
   <span class="n">keyvault_client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span>
      <span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-keyvault&quot;</span><span class="p">);</span>
   <span class="n">keyvault_coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span>
      <span class="n">keyvault_client</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
   <span class="n">index_keys</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">index_name</span> <span class="o">=</span> <span class="n">mongoc_collection_keys_to_index_string</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">create_index_cmd</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;createIndexes&quot;</span><span class="p">,</span>
                                <span class="n">KEYVAULT_COLL</span><span class="p">,</span>
                                <span class="s">&quot;indexes&quot;</span><span class="p">,</span>
                                <span class="s">&quot;[&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;key&quot;</span><span class="p">,</span>
                                <span class="n">BCON_DOCUMENT</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">),</span>
                                <span class="s">&quot;name&quot;</span><span class="p">,</span>
                                <span class="n">index_name</span><span class="p">,</span>
                                <span class="s">&quot;unique&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;$exists&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;]&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_command_simple</span> <span class="p">(</span><span class="n">keyvault_client</span><span class="p">,</span>
                                       <span class="n">KEYVAULT_DB</span><span class="p">,</span>
                                       <span class="n">create_index_cmd</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* read prefs */</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span>
                                       <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">auto_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_auto_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_auto_encryption_opts_set_keyvault_client</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                                    <span class="n">keyvault_client</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">auto_encryption_opts</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                                  <span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">schema</span> <span class="o">=</span> <span class="n">create_schema</span> <span class="p">(</span>
      <span class="n">kms_providers</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">,</span> <span class="n">keyvault_client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schema</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_enable_auto_encryption</span> <span class="p">(</span>
      <span class="n">client</span><span class="p">,</span> <span class="n">auto_encryption_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

   <span class="cm">/* Clear old data */</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Create the collection with the encryption JSON Schema. */</span>
   <span class="n">create_cmd</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">,</span>
                          <span class="n">ENCRYPTED_COLL</span><span class="p">,</span>
                          <span class="s">&quot;validator&quot;</span><span class="p">,</span>
                          <span class="s">&quot;{&quot;</span><span class="p">,</span>
                          <span class="s">&quot;$jsonSchema&quot;</span><span class="p">,</span>
                          <span class="n">BCON_DOCUMENT</span> <span class="p">(</span><span class="n">schema</span><span class="p">),</span>
                          <span class="s">&quot;}&quot;</span><span class="p">);</span>
   <span class="n">wc</span> <span class="o">=</span> <span class="n">mongoc_write_concern_new</span> <span class="p">();</span>
   <span class="n">mongoc_write_concern_set_wmajority</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">create_cmd_opts</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">mongoc_write_concern_append</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">create_cmd_opts</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_command_with_opts</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span>
                                          <span class="n">ENCRYPTED_DB</span><span class="p">,</span>
                                          <span class="n">create_cmd</span><span class="p">,</span>
                                          <span class="nb">NULL</span> <span class="cm">/* read prefs */</span><span class="p">,</span>
                                          <span class="n">create_cmd_opts</span><span class="p">,</span>
                                          <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span>
                                          <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">to_insert</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span> <span class="s">&quot;123456789&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_collection_insert_one</span> <span class="p">(</span>
      <span class="n">coll</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* opts */</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;decrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="n">unencrypted_client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span>
      <span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-unencrypted&quot;</span><span class="p">);</span>
   <span class="n">unencrypted_coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span>
      <span class="n">unencrypted_client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="cm">/* Expect a server-side error if inserting with the unencrypted collection.</span>
<span class="cm">    */</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_collection_insert_one</span> <span class="p">(</span>
      <span class="n">unencrypted_coll</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* opts */</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;insert with unencrypted collection failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">error</span><span class="p">));</span>
   <span class="p">}</span>

   <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_free</span> <span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">index_name</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_index_cmd</span><span class="p">);</span>
   <span class="n">bson_json_reader_destroy</span> <span class="p">(</span><span class="n">reader</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_destroy</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">keyvault_client</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">schema</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_cmd</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_cmd_opts</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_destroy</span> <span class="p">(</span><span class="n">wc</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>
   <span class="k">return</span> <span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="explicit-encryption">
<span id="explicit-client-side-encryption"></span><h3>Explicit Encryption<a class="headerlink" href="#explicit-encryption" title="Permalink to this headline">¶</a></h3>
<p>Explicit encryption is a MongoDB community feature and does not use the mongocryptd process. Explicit encryption is provided by the <a class="symbol reference internal" href="mongoc_client_encryption_t.html"><span class="doc">mongoc_client_encryption_t</span></a> class, for example:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-explicit.c</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span><span class="cp"></span>

<span class="cm">/* This example demonstrates how to use explicit encryption and decryption using</span>
<span class="cm"> * the community version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

   <span class="kt">int</span> <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">local_masterkey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">local_masterkey_len</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">kms_providers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">index_keys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">index_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_index_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">schema</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">keyvault_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">to_insert</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_cmd_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_write_concern_t</span> <span class="o">*</span><span class="n">wc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_t</span> <span class="o">*</span><span class="n">client_encryption</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_opts_t</span> <span class="o">*</span><span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_datakey_opts_t</span> <span class="o">*</span><span class="n">datakey_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;mongoc_encryption_example_3&quot;</span><span class="p">};</span>
   <span class="n">bson_value_t</span> <span class="n">datakey_id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_value_t</span> <span class="n">encrypted_field</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_value_t</span> <span class="n">to_encrypt</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_t</span> <span class="o">*</span><span class="n">encrypt_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_value_t</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create the encryption key. */</span>
   <span class="n">local_masterkey</span> <span class="o">=</span>
      <span class="n">hex_to_bin</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span> <span class="o">||</span> <span class="n">local_masterkey_len</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
               <span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">kms_providers</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
                             <span class="s">&quot;{&quot;</span><span class="p">,</span>
                             <span class="s">&quot;key&quot;</span><span class="p">,</span>
                             <span class="n">BCON_BIN</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">local_masterkey</span><span class="p">,</span> <span class="n">local_masterkey_len</span><span class="p">),</span>
                             <span class="s">&quot;}&quot;</span><span class="p">);</span>

   <span class="cm">/* The mongoc_client_t used to read/write application data. */</span>
   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
   <span class="n">coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

   <span class="cm">/* Clear old data */</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Set up the key vault for this example. */</span>
   <span class="n">keyvault_coll</span> <span class="o">=</span>
      <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
   <span class="n">index_keys</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">index_name</span> <span class="o">=</span> <span class="n">mongoc_collection_keys_to_index_string</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">create_index_cmd</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;createIndexes&quot;</span><span class="p">,</span>
                                <span class="n">KEYVAULT_COLL</span><span class="p">,</span>
                                <span class="s">&quot;indexes&quot;</span><span class="p">,</span>
                                <span class="s">&quot;[&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;key&quot;</span><span class="p">,</span>
                                <span class="n">BCON_DOCUMENT</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">),</span>
                                <span class="s">&quot;name&quot;</span><span class="p">,</span>
                                <span class="n">index_name</span><span class="p">,</span>
                                <span class="s">&quot;unique&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;$exists&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;]&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_command_simple</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span>
                                       <span class="n">KEYVAULT_DB</span><span class="p">,</span>
                                       <span class="n">create_index_cmd</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* read prefs */</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span>
                                       <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                    <span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">client_encryption_opts</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>

   <span class="cm">/* Set a mongoc_client_t to use for reading/writing to the key vault. This</span>
<span class="cm">    * can be the same mongoc_client_t used by the main application. */</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_client</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                      <span class="n">client</span><span class="p">);</span>
   <span class="n">client_encryption</span> <span class="o">=</span>
      <span class="n">mongoc_client_encryption_new</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a new data key for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
   <span class="n">datakey_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_datakey_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span> <span class="p">(</span>
      <span class="n">datakey_opts</span><span class="p">,</span> <span class="n">keyaltnames</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_client_encryption_create_datakey</span> <span class="p">(</span>
          <span class="n">client_encryption</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="n">datakey_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Explicitly encrypt a field */</span>
   <span class="n">encrypt_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_encrypt_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_set_algorithm</span> <span class="p">(</span>
      <span class="n">encrypt_opts</span><span class="p">,</span> <span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_set_keyid</span> <span class="p">(</span><span class="n">encrypt_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
   <span class="n">to_encrypt</span><span class="p">.</span><span class="n">value_type</span> <span class="o">=</span> <span class="n">BSON_TYPE_UTF8</span><span class="p">;</span>
   <span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="s">&quot;123456789&quot;</span><span class="p">;</span>
   <span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_encrypt</span> <span class="p">(</span>
      <span class="n">client_encryption</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_encrypt</span><span class="p">,</span> <span class="n">encrypt_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">to_insert</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">BSON_APPEND_VALUE</span> <span class="p">(</span><span class="n">to_insert</span><span class="p">,</span> <span class="s">&quot;encryptedField&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_collection_insert_one</span> <span class="p">(</span>
      <span class="n">coll</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* opts */</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="cm">/* Explicitly decrypt a field */</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_decrypt</span> <span class="p">(</span>
      <span class="n">client_encryption</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">decrypted</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;decrypted value: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decrypted</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>

   <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_free</span> <span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">index_name</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_index_cmd</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">schema</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_cmd</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_cmd_opts</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_destroy</span> <span class="p">(</span><span class="n">wc</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_destroy</span> <span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_datakey_opts_destroy</span> <span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_destroy</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_destroy</span> <span class="p">(</span><span class="n">encrypt_opts</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">decrypted</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>
   <span class="k">return</span> <span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="explicit-encryption-with-automatic-decryption">
<h3>Explicit Encryption with Automatic Decryption<a class="headerlink" href="#explicit-encryption-with-automatic-decryption" title="Permalink to this headline">¶</a></h3>
<p>Although automatic encryption requires MongoDB 4.2 enterprise or a MongoDB 4.2 Atlas cluster, automatic decryption is supported for all users. To configure automatic decryption without automatic encryption set bypass_auto_encryption=True in <a class="symbol reference internal" href="mongoc_auto_encryption_opts_t.html"><span class="doc">mongoc_auto_encryption_opts_t</span></a>:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-auto-decryption.c</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span><span class="cp"></span>

<span class="cm">/* This example demonstrates how to set up automatic decryption without</span>
<span class="cm"> * automatic encryption using the community version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

   <span class="kt">int</span> <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>
   <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">local_masterkey</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">local_masterkey_len</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">kms_providers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">index_keys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">index_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_index_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">schema</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">keyvault_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">to_insert</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">create_cmd_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_write_concern_t</span> <span class="o">*</span><span class="n">wc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_t</span> <span class="o">*</span><span class="n">client_encryption</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_opts_t</span> <span class="o">*</span><span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_encryption_datakey_opts_t</span> <span class="o">*</span><span class="n">datakey_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;mongoc_encryption_example_4&quot;</span><span class="p">};</span>
   <span class="n">bson_value_t</span> <span class="n">datakey_id</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_value_t</span> <span class="n">encrypted_field</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">bson_value_t</span> <span class="n">to_encrypt</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_t</span> <span class="o">*</span><span class="n">encrypt_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_value_t</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
   <span class="n">mongoc_auto_encryption_opts_t</span> <span class="o">*</span><span class="n">auto_encryption_opts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">unencrypted_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">unencrypted_coll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create the encryption key. */</span>
   <span class="n">local_masterkey</span> <span class="o">=</span>
      <span class="n">hex_to_bin</span> <span class="p">(</span><span class="n">getenv</span> <span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span> <span class="o">||</span> <span class="n">local_masterkey_len</span> <span class="o">!=</span> <span class="mi">96</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
               <span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">kms_providers</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
                             <span class="s">&quot;{&quot;</span><span class="p">,</span>
                             <span class="s">&quot;key&quot;</span><span class="p">,</span>
                             <span class="n">BCON_BIN</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">local_masterkey</span><span class="p">,</span> <span class="n">local_masterkey_len</span><span class="p">),</span>
                             <span class="s">&quot;}&quot;</span><span class="p">);</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
   <span class="n">auto_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_auto_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_auto_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">auto_encryption_opts</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                                  <span class="n">kms_providers</span><span class="p">);</span>

   <span class="cm">/* Setting bypass_auto_encryption to true disables automatic encryption but</span>
<span class="cm">    * keeps the automatic decryption behavior. bypass_auto_encryption will also</span>
<span class="cm">    * disable spawning mongocryptd */</span>
   <span class="n">mongoc_auto_encryption_opts_set_bypass_auto_encryption</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
                                                           <span class="nb">true</span><span class="p">);</span>

   <span class="cm">/* Once bypass_auto_encryption is set, community users can enable auto</span>
<span class="cm">    * encryption on the client. This will, in fact, only perform automatic</span>
<span class="cm">    * decryption. */</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_enable_auto_encryption</span> <span class="p">(</span>
      <span class="n">client</span><span class="p">,</span> <span class="n">auto_encryption_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Now that automatic decryption is on, we can test it by inserting a</span>
<span class="cm">    * document with an explicitly encrypted value into the collection. When we</span>
<span class="cm">    * look up the document later, it should be automatically decrypted for us.</span>
<span class="cm">    */</span>
   <span class="n">coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

   <span class="cm">/* Clear old data */</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Set up the key vault for this example. */</span>
   <span class="n">keyvault_coll</span> <span class="o">=</span>
      <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>
   <span class="n">mongoc_collection_drop</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
   <span class="n">index_keys</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">index_name</span> <span class="o">=</span> <span class="n">mongoc_collection_keys_to_index_string</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">create_index_cmd</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;createIndexes&quot;</span><span class="p">,</span>
                                <span class="n">KEYVAULT_COLL</span><span class="p">,</span>
                                <span class="s">&quot;indexes&quot;</span><span class="p">,</span>
                                <span class="s">&quot;[&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;key&quot;</span><span class="p">,</span>
                                <span class="n">BCON_DOCUMENT</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">),</span>
                                <span class="s">&quot;name&quot;</span><span class="p">,</span>
                                <span class="n">index_name</span><span class="p">,</span>
                                <span class="s">&quot;unique&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
                                <span class="s">&quot;{&quot;</span><span class="p">,</span>
                                <span class="s">&quot;$exists&quot;</span><span class="p">,</span>
                                <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;}&quot;</span><span class="p">,</span>
                                <span class="s">&quot;]&quot;</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_command_simple</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span>
                                       <span class="n">KEYVAULT_DB</span><span class="p">,</span>
                                       <span class="n">create_index_cmd</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* read prefs */</span><span class="p">,</span>
                                       <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span>
                                       <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client_encryption_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_opts_set_kms_providers</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                    <span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span> <span class="p">(</span>
      <span class="n">client_encryption_opts</span><span class="p">,</span> <span class="n">KEYVAULT_DB</span><span class="p">,</span> <span class="n">KEYVAULT_COLL</span><span class="p">);</span>

   <span class="cm">/* The key vault client is used for reading to/from the key vault. This can</span>
<span class="cm">    * be the same mongoc_client_t used by the application. */</span>
   <span class="n">mongoc_client_encryption_opts_set_keyvault_client</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
                                                      <span class="n">client</span><span class="p">);</span>
   <span class="n">client_encryption</span> <span class="o">=</span>
      <span class="n">mongoc_client_encryption_new</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Create a new data key for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
   <span class="n">datakey_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_datakey_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span> <span class="p">(</span>
      <span class="n">datakey_opts</span><span class="p">,</span> <span class="n">keyaltnames</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_create_datakey</span> <span class="p">(</span>
      <span class="n">client_encryption</span><span class="p">,</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="n">datakey_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* Explicitly encrypt a field. */</span>
   <span class="n">encrypt_opts</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_encrypt_opts_new</span> <span class="p">();</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_set_algorithm</span> <span class="p">(</span>
      <span class="n">encrypt_opts</span><span class="p">,</span> <span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_set_keyaltname</span> <span class="p">(</span>
      <span class="n">encrypt_opts</span><span class="p">,</span> <span class="s">&quot;mongoc_encryption_example_4&quot;</span><span class="p">);</span>
   <span class="n">to_encrypt</span><span class="p">.</span><span class="n">value_type</span> <span class="o">=</span> <span class="n">BSON_TYPE_UTF8</span><span class="p">;</span>
   <span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="s">&quot;123456789&quot;</span><span class="p">;</span>
   <span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_client_encryption_encrypt</span> <span class="p">(</span>
      <span class="n">client_encryption</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to_encrypt</span><span class="p">,</span> <span class="n">encrypt_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">to_insert</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">BSON_APPEND_VALUE</span> <span class="p">(</span><span class="n">to_insert</span><span class="p">,</span> <span class="s">&quot;encryptedField&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_collection_insert_one</span> <span class="p">(</span>
      <span class="n">coll</span><span class="p">,</span> <span class="n">to_insert</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* opts */</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* reply */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* When we retrieve the document, any encrypted fields will get automatically</span>
<span class="cm">    * decrypted by the driver. */</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;decrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="n">unencrypted_client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
   <span class="n">unencrypted_coll</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span>
      <span class="n">unencrypted_client</span><span class="p">,</span> <span class="n">ENCRYPTED_DB</span><span class="p">,</span> <span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span> <span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="n">exit_status</span> <span class="o">=</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_free</span> <span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">index_name</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_index_cmd</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">schema</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_cmd</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">create_cmd_opts</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_destroy</span> <span class="p">(</span><span class="n">wc</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_destroy</span> <span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_datakey_opts_destroy</span> <span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_opts_destroy</span> <span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
   <span class="n">mongoc_client_encryption_encrypt_opts_destroy</span> <span class="p">(</span><span class="n">encrypt_opts</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">decrypted</span><span class="p">);</span>
   <span class="n">bson_value_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>
   <span class="n">mongoc_auto_encryption_opts_destroy</span> <span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>
   <span class="k">return</span> <span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing the MongoDB C Driver (libmongoc) and BSON library (libbson)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic-troubleshooting.html">Basic Troubleshooting</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="guides.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="configuring_tls.html">Configuring TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoc-common-task-examples.html">Common Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-connections.html">Advanced Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection-pooling.html">Connection Pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="cursors.html">Cursors</a></li>
<li class="toctree-l2"><a class="reference internal" href="bulk.html">Bulk Write Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="aggregate.html">Aggregation Framework Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="distinct-mapreduce.html">“distinct” and “mapReduce”</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual-studio-guide.html">Using libmongoc in a Microsoft Visual Studio project</a></li>
<li class="toctree-l2"><a class="reference internal" href="create-indexes.html">Creating Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Aids for Debugging</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using Client-Side Field Level Encryption</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="application-performance-monitoring.html">Application Performance Monitoring (APM)</a></li>
</ul>
<!-- Because full_index.rst includes everything that index.rst includes, we have to exclude index.rst from the table-of-contents. This page is simply a link forced into the sidebar (in conf.py) to avoid including full_index.rst in the ToC. -->
<ul><li class='toctree-l1'><a href="full_index.html">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2017-present, MongoDB, Inc.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.
  </div>
  
  </body>
</html>