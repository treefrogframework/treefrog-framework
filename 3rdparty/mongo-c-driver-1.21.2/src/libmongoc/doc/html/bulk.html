
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><link rel="canonical" href="http://mongoc.org/libbson/current/bulk.html"/>
    <title>Bulk Write Operations &#8212; libmongoc 1.21.2</title>
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Aggregation Framework Examples" href="aggregate.html" />
    <link rel="prev" title="Cursors" href="cursors.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="aggregate.html" title="Aggregation Framework Examples"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="cursors.html" title="Cursors"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">libmongoc 1.21.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="guides.html" accesskey="U">Guides</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="bulk-write-operations">
<h1>Bulk Write Operations<a class="headerlink" href="#bulk-write-operations" title="Permalink to this headline">¶</a></h1>
<p>This tutorial explains how to take advantage of MongoDB C driver bulk write operation features. Executing write operations in batches reduces the number of network round trips, increasing write throughput.</p>
<div class="section" id="bulk-insert">
<h2>Bulk Insert<a class="headerlink" href="#bulk-insert" title="Permalink to this headline">¶</a></h2>
<p>First we need to fetch a bulk operation handle from the <a class="symbol reference internal" href="mongoc_collection_t.html"><span class="doc">mongoc_collection_t</span></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span> <span class="o">=</span>
   <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p>We can now start inserting documents to the bulk operation. These will be buffered until we execute the operation.</p>
<p>The bulk operation will coalesce insertions as a single batch for each consecutive call to <a class="symbol reference internal" href="mongoc_bulk_operation_insert.html"><span class="doc">mongoc_bulk_operation_insert()</span></a>. This creates a pipelined effect when possible.</p>
<p>To execute the bulk operation and receive the result we call <a class="symbol reference internal" href="mongoc_bulk_operation_execute.html"><span class="doc">mongoc_bulk_operation_execute()</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">bulk1.c</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk1</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
      <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
      <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk1-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>

   <span class="n">bulk1</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>

   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Example <code class="docutils literal notranslate"><span class="pre">reply</span></code> document:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{&quot;nInserted&quot;   : 10000,
 &quot;nMatched&quot;    : 0,
 &quot;nModified&quot;   : 0,
 &quot;nRemoved&quot;    : 0,
 &quot;nUpserted&quot;   : 0,
 &quot;writeErrors&quot; : []
 &quot;writeConcernErrors&quot; : [] }
</pre></div>
</div>
</div>
<div class="section" id="mixed-bulk-write-operations">
<h2>Mixed Bulk Write Operations<a class="headerlink" href="#mixed-bulk-write-operations" title="Permalink to this headline">¶</a></h2>
<p>MongoDB C driver also supports executing mixed bulk write operations. A batch of insert, update, and remove operations can be executed together using the bulk write operations API.</p>
</div>
<div class="section" id="ordered-bulk-write-operations">
<h2>Ordered Bulk Write Operations<a class="headerlink" href="#ordered-bulk-write-operations" title="Permalink to this headline">¶</a></h2>
<p>Ordered bulk write operations are batched and sent to the server in the order provided for serial execution. The <code class="docutils literal notranslate"><span class="pre">reply</span></code> document describes the type and count of operations performed.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">bulk2.c</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk2</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">opts</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Remove everything */</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">mongoc_bulk_operation_remove</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>

   <span class="cm">/* Add a few documents */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
      <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
      <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="cm">/* {_id: 1} =&gt; {$set: {foo: &quot;bar&quot;}} */</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;$set&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;bar&quot;</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_update_many_with_opts</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="cm">/* {_id: 4} =&gt; {&#39;$inc&#39;: {&#39;j&#39;: 1}} (upsert) */</span>
   <span class="n">opts</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;upsert&quot;</span><span class="p">,</span> <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">));</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">4</span><span class="p">));</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;$inc&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;j&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_update_many_with_opts</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">opts</span><span class="p">);</span>

   <span class="cm">/* replace {j:1} with {j:2} */</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;j&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;j&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">2</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_replace_one_with_opts</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk2-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>

   <span class="n">bulk2</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>

   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Example <code class="docutils literal notranslate"><span class="pre">reply</span></code> document:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ &quot;nInserted&quot;   : 3,
  &quot;nMatched&quot;    : 2,
  &quot;nModified&quot;   : 2,
  &quot;nRemoved&quot;    : 10000,
  &quot;nUpserted&quot;   : 1,
  &quot;upserted&quot;    : [{&quot;index&quot; : 5, &quot;_id&quot; : 4}],
  &quot;writeErrors&quot; : []
  &quot;writeConcernErrors&quot; : [] }
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">index</span></code> field in the <code class="docutils literal notranslate"><span class="pre">upserted</span></code> array is the 0-based index of the upsert operation; in this example, the sixth operation of the overall bulk operation was an upsert, so its index is 5.</p>
</div>
<div class="section" id="unordered-bulk-write-operations">
<h2>Unordered Bulk Write Operations<a class="headerlink" href="#unordered-bulk-write-operations" title="Permalink to this headline">¶</a></h2>
<p>Unordered bulk write operations are batched and sent to the server in <em>arbitrary order</em> where they may be executed in parallel. Any errors that occur are reported after all operations are attempted.</p>
<p>In the next example the first and third operations fail due to the unique constraint on <code class="docutils literal notranslate"><span class="pre">_id</span></code>. Since we are doing unordered execution the second and fourth operations succeed.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">bulk3.c</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk3</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">bson_t</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">BSON_INITIALIZER</span><span class="p">;</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>

   <span class="cm">/* false indicates unordered */</span>
   <span class="n">BSON_APPEND_BOOL</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;ordered&quot;</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>

   <span class="cm">/* Add a document */</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="cm">/* remove {_id: 2} */</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">2</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_remove_one</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>

   <span class="cm">/* insert {_id: 3} */</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">3</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="cm">/* replace {_id:4} {&#39;i&#39;: 1} */</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">4</span><span class="p">));</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_replace_one</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk3-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>

   <span class="n">bulk3</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>

   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Example <code class="docutils literal notranslate"><span class="pre">reply</span></code> document:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ &quot;nInserted&quot;    : 0,
  &quot;nMatched&quot;     : 1,
  &quot;nModified&quot;    : 1,
  &quot;nRemoved&quot;     : 1,
  &quot;nUpserted&quot;    : 0,
  &quot;writeErrors&quot;  : [
    { &quot;index&quot;  : 0,
      &quot;code&quot;   : 11000,
      &quot;errmsg&quot; : &quot;E11000 duplicate key error index: test.test.$_id_ dup key: { : 1 }&quot; },
    { &quot;index&quot;  : 2,
      &quot;code&quot;   : 11000,
      &quot;errmsg&quot; : &quot;E11000 duplicate key error index: test.test.$_id_ dup key: { : 3 }&quot; } ],
  &quot;writeConcernErrors&quot; : [] }

Error: E11000 duplicate key error index: test.test.$_id_ dup key: { : 1 }
</pre></div>
</div>
<p>The <a class="symbol reference internal" href="errors.html"><span class="doc">bson_error_t</span></a> domain is <code class="docutils literal notranslate"><span class="pre">MONGOC_ERROR_COMMAND</span></code> and its code is 11000.</p>
</div>
<div class="section" id="bulk-operation-bypassing-document-validation">
<span id="id1"></span><h2>Bulk Operation Bypassing Document Validation<a class="headerlink" href="#bulk-operation-bypassing-document-validation" title="Permalink to this headline">¶</a></h2>
<p>This feature is only available when using MongoDB 3.2 and later.</p>
<p>By default bulk operations are validated against the schema, if any is defined. In certain cases however it may be necessary to bypass the document validation.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">bulk5.c</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk5_fail</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>

   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Two inserts */</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">31</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">32</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="cm">/* The above documents do not comply to the schema validation rules</span>
<span class="cm">    * we created previously, so this will result in an error */</span>
   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk5_success</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>

   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="cm">/* Allow this document to bypass document validation.</span>
<span class="cm">    * NOTE: When authentication is enabled, the authenticated user must have</span>
<span class="cm">    * either the &quot;dbadmin&quot; or &quot;restore&quot; roles to bypass document validation */</span>
   <span class="n">mongoc_bulk_operation_set_bypass_document_validation</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

   <span class="cm">/* Two inserts */</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">31</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">32</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">options</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">mongoc_database_t</span> <span class="o">*</span><span class="n">database</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk5-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">database</span> <span class="o">=</span> <span class="n">mongoc_client_get_database</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;testasdf&quot;</span><span class="p">);</span>

   <span class="cm">/* Create schema validator */</span>
   <span class="n">options</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span>
      <span class="s">&quot;validator&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;number&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;$gte&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">,</span> <span class="s">&quot;}&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span>
      <span class="n">mongoc_database_create_collection</span> <span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;collname&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">bulk5_fail</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
      <span class="n">bulk5_success</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
      <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t create collection: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_free</span> <span class="p">(</span><span class="n">options</span><span class="p">);</span>
   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_database_destroy</span> <span class="p">(</span><span class="n">database</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Running the above example will result in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ &quot;nInserted&quot; : 0,
  &quot;nMatched&quot; : 0,
  &quot;nModified&quot; : 0,
  &quot;nRemoved&quot; : 0,
  &quot;nUpserted&quot; : 0,
  &quot;writeErrors&quot; : [
    { &quot;index&quot; : 0,
      &quot;code&quot; : 121,
      &quot;errmsg&quot; : &quot;Document failed validation&quot; } ] }

Error: Document failed validation

{ &quot;nInserted&quot; : 2,
  &quot;nMatched&quot; : 0,
  &quot;nModified&quot; : 0,
  &quot;nRemoved&quot; : 0,
  &quot;nUpserted&quot; : 0,
  &quot;writeErrors&quot; : [] }
</pre></div>
</div>
<p>The <a class="symbol reference internal" href="errors.html"><span class="doc">bson_error_t</span></a> domain is <code class="docutils literal notranslate"><span class="pre">MONGOC_ERROR_COMMAND</span></code>.</p>
</div>
<div class="section" id="bulk-operation-write-concerns">
<h2>Bulk Operation Write Concerns<a class="headerlink" href="#bulk-operation-write-concerns" title="Permalink to this headline">¶</a></h2>
<p>By default bulk operations are executed with the <a class="symbol reference internal" href="mongoc_write_concern_t.html"><span class="doc">write_concern</span></a> of the collection they are executed against. A custom write concern can be passed to the <a class="symbol reference internal" href="mongoc_collection_create_bulk_operation_with_opts.html"><span class="doc">mongoc_collection_create_bulk_operation_with_opts()</span></a> method. Write concern errors (e.g. wtimeout) will be reported after all operations are attempted, regardless of execution order.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">bulk4.c</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk4</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">bson_t</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">BSON_INITIALIZER</span><span class="p">;</span>
   <span class="n">mongoc_write_concern_t</span> <span class="o">*</span><span class="n">wc</span><span class="p">;</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>

   <span class="n">wc</span> <span class="o">=</span> <span class="n">mongoc_write_concern_new</span> <span class="p">();</span>
   <span class="n">mongoc_write_concern_set_w</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_set_wtimeout_int64</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span> <span class="cm">/* milliseconds */</span>
   <span class="n">mongoc_write_concern_append</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>

   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>

   <span class="cm">/* Two inserts */</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">10</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">11</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_destroy</span> <span class="p">(</span><span class="n">wc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk4-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>

   <span class="n">bulk4</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>

   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Example <code class="docutils literal notranslate"><span class="pre">reply</span></code> document and error message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ &quot;nInserted&quot;    : 2,
  &quot;nMatched&quot;     : 0,
  &quot;nModified&quot;    : 0,
  &quot;nRemoved&quot;     : 0,
  &quot;nUpserted&quot;    : 0,
  &quot;writeErrors&quot;  : [],
  &quot;writeConcernErrors&quot; : [
    { &quot;code&quot;   : 64,
      &quot;errmsg&quot; : &quot;waiting for replication timed out&quot; }
] }

Error: waiting for replication timed out
</pre></div>
</div>
<p>The <a class="symbol reference internal" href="errors.html"><span class="doc">bson_error_t</span></a> domain is <code class="docutils literal notranslate"><span class="pre">MONGOC_ERROR_WRITE_CONCERN</span></code> if there are write concern errors and no write errors. Write errors indicate failed operations, so they take precedence over write concern errors, which mean merely that the write concern is not satisfied <em>yet</em>.</p>
</div>
<div class="section" id="setting-collation-order">
<span id="id2"></span><h2>Setting Collation Order<a class="headerlink" href="#setting-collation-order" title="Permalink to this headline">¶</a></h2>
<p>This feature is only available when using MongoDB 3.4 and later.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">bulk-collation.c</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk_collation</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">opts</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">selector</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">update</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">uint32_t</span> <span class="n">ret</span><span class="p">;</span>

   <span class="cm">/* insert {_id: &quot;one&quot;} and {_id: &quot;One&quot;} */</span>
   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span>
      <span class="n">collection</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;one&quot;</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;One&quot;</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="cm">/* &quot;One&quot; normally sorts before &quot;one&quot;; make &quot;one&quot; come first */</span>
   <span class="n">opts</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;collation&quot;</span><span class="p">,</span>
                    <span class="s">&quot;{&quot;</span><span class="p">,</span>
                    <span class="s">&quot;locale&quot;</span><span class="p">,</span>
                    <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;en_US&quot;</span><span class="p">),</span>
                    <span class="s">&quot;caseFirst&quot;</span><span class="p">,</span>
                    <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;lower&quot;</span><span class="p">),</span>
                    <span class="s">&quot;}&quot;</span><span class="p">);</span>

   <span class="cm">/* set x=1 on the document with _id &quot;One&quot;, which now sorts after &quot;one&quot; */</span>
   <span class="n">update</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;$set&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">BCON_INT64</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">);</span>
   <span class="n">selector</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;$gt&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;one&quot;</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_update_one_with_opts</span> <span class="p">(</span>
      <span class="n">bulk</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">update</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">selector</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">opts</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk-collation&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="s">&quot;collection&quot;</span><span class="p">);</span>
   <span class="n">bulk_collation</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>

   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Running the above example will result in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ &quot;nInserted&quot; : 2,
   &quot;nMatched&quot; : 1,
   &quot;nModified&quot; : 1,
   &quot;nRemoved&quot; : 0,
   &quot;nUpserted&quot; : 0,
   &quot;writeErrors&quot; : [  ]
}
</pre></div>
</div>
</div>
<div class="section" id="unacknowledged-bulk-writes">
<h2>Unacknowledged Bulk Writes<a class="headerlink" href="#unacknowledged-bulk-writes" title="Permalink to this headline">¶</a></h2>
<p>Set “w” to zero for an unacknowledged write. The driver sends unacknowledged writes using the legacy opcodes <code class="docutils literal notranslate"><span class="pre">OP_INSERT</span></code>, <code class="docutils literal notranslate"><span class="pre">OP_UPDATE</span></code>, and <code class="docutils literal notranslate"><span class="pre">OP_DELETE</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">bulk6.c</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bulk6</span> <span class="p">(</span><span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">bson_t</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">BSON_INITIALIZER</span><span class="p">;</span>
   <span class="n">mongoc_write_concern_t</span> <span class="o">*</span><span class="n">wc</span><span class="p">;</span>
   <span class="n">mongoc_bulk_operation_t</span> <span class="o">*</span><span class="n">bulk</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">selector</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">ret</span><span class="p">;</span>

   <span class="n">wc</span> <span class="o">=</span> <span class="n">mongoc_write_concern_new</span> <span class="p">();</span>
   <span class="n">mongoc_write_concern_set_w</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_append</span> <span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>

   <span class="n">bulk</span> <span class="o">=</span> <span class="n">mongoc_collection_create_bulk_operation_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">10</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_insert</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">doc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">selector</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">11</span><span class="p">));</span>
   <span class="n">mongoc_bulk_operation_remove_one</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">selector</span><span class="p">);</span>

   <span class="n">ret</span> <span class="o">=</span> <span class="n">mongoc_bulk_operation_execute</span> <span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_bulk_operation_destroy</span> <span class="p">(</span><span class="n">bulk</span><span class="p">);</span>
   <span class="n">mongoc_write_concern_destroy</span> <span class="p">(</span><span class="n">wc</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost/?appname=bulk6-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_set_error_api</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>

   <span class="n">bulk6</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>

   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">reply</span></code> document is empty:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ }
</pre></div>
</div>
</div>
<div class="section" id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<p>See the <a class="reference external" href="https://github.com/mongodb/specifications/blob/master/source/driver-bulk-update.rst">Driver Bulk API Spec</a>, which describes bulk write operations for all MongoDB drivers.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing the MongoDB C Driver (libmongoc) and BSON library (libbson)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic-troubleshooting.html">Basic Troubleshooting</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="guides.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="configuring_tls.html">Configuring TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoc-common-task-examples.html">Common Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-connections.html">Advanced Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection-pooling.html">Connection Pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="cursors.html">Cursors</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Bulk Write Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="aggregate.html">Aggregation Framework Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="distinct-mapreduce.html">“distinct” and “mapReduce”</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual-studio-guide.html">Using libmongoc in a Microsoft Visual Studio project</a></li>
<li class="toctree-l2"><a class="reference internal" href="create-indexes.html">Creating Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Aids for Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="using_client_side_encryption.html">Using Client-Side Field Level Encryption</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="application-performance-monitoring.html">Application Performance Monitoring (APM)</a></li>
</ul>
<!-- Because full_index.rst includes everything that index.rst includes, we have to exclude index.rst from the table-of-contents. This page is simply a link forced into the sidebar (in conf.py) to avoid including full_index.rst in the ToC. -->
<ul><li class='toctree-l1'><a href="full_index.html">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2017-present, MongoDB, Inc.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.2.
  </div>
  
  </body>
</html>